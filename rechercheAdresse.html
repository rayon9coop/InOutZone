<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte des rues de Liège</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
        }
        .status-loading {
            background-color: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        .status-error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        .status-success {
            background-color: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .search-container {
            position: relative;
            margin: 20px 0;
        }
        .search-box {
            padding: 10px;
            width: 100%;
            max-width: 400px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .zone-indicator {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: #28a745;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-50%) translateX(10px); }
            to { opacity: 1; transform: translateY(-50%) translateX(0); }
        }
        .streets-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .street-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .street-item:hover {
            background-color: #f8f9fa;
        }
        .street-item.highlighted {
            background-color: #e7f3ff;
            border-left: 4px solid #007bff;
        }
        .street-info {
            flex-grow: 1;
        }
        .street-name {
            font-weight: bold;
            color: #333;
            text-transform: capitalize;
        }
        .street-details {
            font-size: 0.9em;
            color: #666;
        }
        .coordinates {
            font-family: monospace;
            font-size: 0.8em;
            color: #999;
            text-align: right;
        }
        .zone-badge {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .no-results {
            padding: 20px;
            text-align: center;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Carte des rues de Liège</h1>
        
        <div id="statusMessage" class="status-message status-loading">
            Chargement des données...
        </div>
        
        <div class="stats" id="stats"></div>
        
        <div class="search-container">
            <input type="text" id="searchBox" class="search-box" placeholder="Rechercher une rue..." disabled>
            <div id="zoneIndicator" class="zone-indicator">Dans la zone</div>
        </div>
        
        <div class="streets-list" id="streetsList"></div>
    </div>

    <script>
        let streets = [];

        // Fonction pour afficher les messages de statut
        function showStatus(message, type = 'loading') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message status-${type}`;
            statusEl.style.display = 'block';
        }

        function hideStatus() {
            document.getElementById('statusMessage').style.display = 'none';
        }

        // Fonction pour parser une ligne CSV avec gestion des guillemets
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"' && (i === 0 || line[i-1] === ',')) {
                    inQuotes = true;
                } else if (char === '"' && inQuotes && (i === line.length - 1 || line[i+1] === ',')) {
                    inQuotes = false;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else if (char !== '"' || (inQuotes && char === '"')) {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        // Fonction pour charger les données depuis le CSV
        async function loadStreetsData() {
            // D'abord, essayons de charger le fichier CSV
            const possibleFilenames = [
                'Détails Rue Rayon9_V2.csv',
                'Details Rue Rayon9_V2.csv',
                'Détails_Rue_Rayon9_V2.csv',
                'Details_Rue_Rayon9_V2.csv'
            ];

            for (const filename of possibleFilenames) {
                try {
                    console.log(`Tentative de chargement: ${filename}`);
                    
                    // Vérifier si window.fs existe
                    if (typeof window.fs === 'undefined' || typeof window.fs.readFile !== 'function') {
                        throw new Error('API de fichier non disponible dans cet environnement');
                    }
                    
                    const csvContent = await window.fs.readFile(filename, { encoding: 'utf8' });
                    
                    const lines = csvContent.split('\n').filter(line => line.trim());
                    console.log(`Trouvé ${lines.length} lignes dans ${filename}`);
                    
                    if (lines.length < 2) {
                        throw new Error('Fichier vide ou sans données');
                    }
                    
                    const headers = parseCSVLine(lines[0]);
                    console.log('En-têtes détectés:', headers);
                    
                    const streets = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line) {
                            const values = parseCSVLine(line);
                            
                            if (values.length >= 6) {
                                // Nettoyage et conversion des coordonnées
                                const latStr = values[3].replace(/[",]/g, '').replace(',', '.');
                                const lngStr = values[4].replace(/[",]/g, '').replace(',', '.');
                                
                                const lat = parseFloat(latStr);
                                const lng = parseFloat(lngStr);
                                
                                if (!isNaN(lat) && !isNaN(lng)) {
                                    streets.push({
                                        postcode: parseInt(values[0]) || 0,
                                        city: values[1].replace(/[",]/g, '').trim(),
                                        street: values[2].replace(/[",]/g, '').toLowerCase().trim(),
                                        lat: lat,
                                        lng: lng,
                                        zone: values[5].replace(/[",]/g, '').trim()
                                    });
                                }
                            }
                        }
                    }
                    
                    if (streets.length === 0) {
                        throw new Error('Aucune donnée valide trouvée');
                    }
                    
                    console.log(`${streets.length} rues chargées avec succès`);
                    showStatus(`${streets.length} rues chargées avec succès depuis ${filename}`, 'success');
                    setTimeout(hideStatus, 3000);
                    
                    return streets;
                    
                } catch (error) {
                    console.log(`Erreur avec ${filename}:`, error.message);
                    continue;
                }
            }
            
            // Si aucun fichier n'a pu être chargé, utiliser des données d'exemple étendues
            console.warn('Impossible de charger le fichier CSV, utilisation des données de démonstration');
            showStatus('Fichier CSV introuvable - Mode démonstration avec données d\'exemple', 'error');
            
            return [
                {
                    "postcode": 4020,
                    "city": "Liège",
                    "street": "rue de Mulhouse",
                    "lat": 50,632744004201	,
                    "lng": 5,5861573070173,
                    "zone": "4020AS"
                }
            ];
        }

        // Fonction pour calculer les statistiques
        function calculateStats() {
            const totalStreets = streets.length;
            const postcodes = [...new Set(streets.map(s => s.postcode))];
            const zones = [...new Set(streets.map(s => s.zone))];
            const cities = [...new Set(streets.map(s => s.city))];

            return {
                totalStreets,
                postcodes: postcodes.length,
                zones: zones.length,
                cities: cities.length
            };
        }

        // Fonction pour afficher les statistiques
        function displayStats() {
            const stats = calculateStats();
            const statsContainer = document.getElementById('stats');
            
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.totalStreets}</div>
                    <div>Rues totales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.postcodes}</div>
                    <div>Codes postaux</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.zones}</div>
                    <div>Zones</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.cities}</div>
                    <div>Villes</div>
                </div>
            `;
        }

        // Fonction pour afficher les rues
        function displayStreets(streetsToShow = streets, highlightedStreet = null) {
            const streetsList = document.getElementById('streetsList');
            
            if (streetsToShow.length === 0) {
                streetsList.innerHTML = '<div class="no-results">Aucune rue trouvée</div>';
                return;
            }

            streetsList.innerHTML = streetsToShow.map(street => {
                const isHighlighted = highlightedStreet && street.street === highlightedStreet.street;
                return `
                    <div class="street-item ${isHighlighted ? 'highlighted' : ''}">
                        <div class="street-info">
                            <div class="street-name">${street.street}</div>
                            <div class="street-details">${street.postcode} ${street.city}</div>
                        </div>
                        <div class="coordinates">
                            ${street.lat.toFixed(6)}, ${street.lng.toFixed(6)}
                        </div>
                        <div class="zone-badge">${street.zone}</div>
                    </div>
                `;
            }).join('');
        }

        // Fonction de recherche
        function searchStreets(query) {
            if (!query.trim()) {
                return { results: streets, exactMatch: null };
            }
            
            const searchTerm = query.toLowerCase().trim();
            
            // Recherche exacte d'abord
            const exactMatch = streets.find(street => 
                street.street.toLowerCase() === searchTerm
            );
            
            // Puis recherche partielle
            const results = streets.filter(street => 
                street.street.toLowerCase().includes(searchTerm) ||
                street.city.toLowerCase().includes(searchTerm) ||
                street.postcode.toString().includes(searchTerm) ||
                street.zone.toLowerCase().includes(searchTerm)
            );
            
            return { results, exactMatch };
        }

        // Fonction pour afficher/masquer l'indicateur "Dans la zone"
        function toggleZoneIndicator(show) {
            const indicator = document.getElementById('zoneIndicator');
            indicator.style.display = show ? 'block' : 'none';
        }

        // Gestionnaire d'événements pour la recherche
        document.getElementById('searchBox').addEventListener('input', function(e) {
            const { results, exactMatch } = searchStreets(e.target.value);
            
            // Afficher "Dans la zone" si correspondance exacte
            toggleZoneIndicator(!!exactMatch);
            
            // Afficher les résultats avec mise en évidence si correspondance exacte
            displayStreets(results, exactMatch);
        });

        // Initialisation
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                streets = await loadStreetsData();
                
                // Activer la recherche
                document.getElementById('searchBox').disabled = false;
                
                displayStats();
                displayStreets();
                
            } catch (error) {
                console.error('Erreur fatale lors de l\'initialisation:', error);
                showStatus('Erreur lors du chargement de l\'application', 'error');
            }
        });
    </script>
</body>
</html>
